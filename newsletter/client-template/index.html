<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563EB">
<title>Newsletter Archive</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",sans-serif;background:#f8fafc;color:#1e293b;padding:40px 20px}
.container{max-width:640px;margin:0 auto}
.header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:8px}
h1{font-size:1.5rem}
.lang-switch{font-size:.75rem;color:var(--accent,#2563eb);text-decoration:none;padding:.25rem .5rem;border:1px solid var(--accent,#2563eb);border-radius:4px;cursor:pointer}
.lang-switch:hover{background:var(--accent,#2563eb);color:#fff}
.sub{color:#64748b;font-size:.875rem;margin-bottom:32px}
.empty{color:#94a3b8;text-align:center;padding:40px}
footer{margin-top:40px;text-align:center;color:#94a3b8;font-size:.75rem}
footer a{color:var(--accent,#2563eb);text-decoration:none}

.century{border:1px solid #e2e8f0;border-radius:10px;margin-bottom:.75rem;background:#fafbfc}
.century summary{font-size:.95rem;font-weight:600;color:#1e293b;padding:.7rem 1rem;cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem}
.century summary::-webkit-details-marker{display:none}
.century summary::before{content:'▸';font-size:.75rem;color:var(--accent,#C9A962);transition:transform .15s}
.century[open] summary::before{transform:rotate(90deg)}
.century-count{font-size:.75rem;font-weight:400;color:#94a3b8}
.century-inner{padding:0 .5rem .5rem 1rem}

.vol{border:1px solid #e8ecf0;border-radius:6px;margin-bottom:.4rem;background:#fff}
.vol summary{font-size:.82rem;font-weight:600;color:#475569;padding:.45rem .8rem;cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem}
.vol summary::-webkit-details-marker{display:none}
.vol summary::before{content:'▸';font-size:.6rem;color:#94a3b8;transition:transform .15s}
.vol[open] summary::before{transform:rotate(90deg)}
.vol-count{font-size:.72rem;font-weight:400;color:#94a3b8}
.vol-issues{padding:.3rem .8rem .5rem 1.5rem}

.issue-row{display:flex;align-items:stretch;gap:0;margin-bottom:8px}
.issue-row .issue{flex:1;margin-bottom:0;border-radius:6px 0 0 6px;border-right:none}
.play-btn{display:flex;align-items:center;justify-content:center;width:44px;background:#fff;border:1px solid #e2e8f0;border-left:none;border-radius:0 6px 6px 0;color:var(--accent,#2563eb);font-size:1rem;text-decoration:none;transition:background .15s,color .15s;flex-shrink:0}
.play-btn:hover{background:var(--accent,#2563eb);color:#fff}
.issue{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:8px;text-decoration:none;color:inherit;transition:box-shadow .15s,border-color .15s}
.issue:hover{box-shadow:0 2px 8px rgba(0,0,0,.08);border-color:var(--accent,#C9A962)}
.issue-serial{font-weight:700;font-size:.8rem;min-width:72px;color:var(--accent,#2563eb)}
.issue-meta{color:#64748b;font-size:.8rem}

.section-label{font-size:.75rem;font-weight:600;color:#94a3b8;letter-spacing:.08em;margin:24px 0 12px;padding-bottom:6px;border-bottom:1px solid #e2e8f0}

.pwa-banner{position:fixed;bottom:0;left:0;right:0;z-index:2000;background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -2px 12px rgba(0,0,0,.08);padding:.8rem 1rem;display:none;align-items:center;gap:.7rem;animation:pwa-up .3s ease-out}
@keyframes pwa-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.pwa-banner-text{flex:1;min-width:0}
.pwa-banner-title{font-size:.85rem;font-weight:600;color:#1e293b}
.pwa-banner-desc{font-size:.72rem;color:#64748b;margin-top:.15rem;line-height:1.4}
.pwa-banner .pwa-btn{background:var(--accent,#2563eb);color:#fff;border:none;border-radius:6px;padding:.45rem 1rem;font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap}
.pwa-banner .pwa-btn:hover{opacity:.9}
.pwa-banner .pwa-close{background:none;border:none;font-size:1.2rem;color:#94a3b8;cursor:pointer;padding:.2rem .4rem;line-height:1}
.pwa-banner .pwa-close:hover{color:#64748b}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="title">Newsletter Archive</h1>
    <span class="lang-switch" id="lang-btn">EN</span>
  </div>
  <p class="sub" id="sub"></p>
  <div id="list"><p class="empty">Loading...</p></div>
  <footer id="footer"></footer>
</div>
<div class="pwa-banner" id="pwaBanner">
  <div class="pwa-banner-text">
    <div class="pwa-banner-title" id="pwaTitle"></div>
    <div class="pwa-banner-desc" id="pwaDesc"></div>
  </div>
  <button class="pwa-btn" id="pwaBtn"></button>
  <button class="pwa-close" id="pwaClose" aria-label="Close">&times;</button>
</div>
<script>
(async function(){
  var L={
    ja:{
      sub:'国立国会図書館に納本されたニュースレター。',
      latest:'最新',
      backissues:'バックナンバー',
      century:function(c,r){return'第'+c+'世紀（'+r+'）'},
      vol:function(v,p){return'第'+v+'巻（'+p+'）'},
      count:function(n){return n+'件'},
      empty:'まだ発行されていません。',
      noSchedule:'スケジュールが見つかりません。',
      mission:'あなたが物語になり、世代の対話が重なり、未来の道になる。',
      footer:'発行：<a href="https://tokistorage.github.io/lp/">TokiStorage</a> &middot; <a href="https://tokistorage.github.io/lp/newsletters.html">ニュースレター一覧</a> &middot; 国立国会図書館法 第25条の4に基づき納本',
      toggle:'EN',
      pwaTitle:'ホーム画面に追加',
      pwaDesc:'オフラインでもバックナンバーを閲覧できます',
      pwaInstall:'追加',
      pwaIos:'共有ボタン（□↑）→「ホーム画面に追加」をタップ',
      play:'TokiQRで再生'
    },
    en:{
      sub:'Published newsletters deposited with the National Diet Library of Japan.',
      latest:'Latest',
      backissues:'Back Issues',
      century:function(c,r){return'Century '+c+' ('+r+')'},
      vol:function(v,p){return'Vol. '+v+' ('+p+')'},
      count:function(n){return n+(n===1?' issue':' issues')},
      empty:'No published issues yet.',
      noSchedule:'No schedule found.',
      mission:'You become a story, generations connect in dialog, the path forward.',
      footer:'Published by <a href="https://tokistorage.github.io/lp/">TokiStorage</a> &middot; <a href="https://tokistorage.github.io/lp/newsletters.html">All Newsletters</a> &middot; Deposited under NDL Law Article 25-4',
      toggle:'JA',
      pwaTitle:'Add to Home Screen',
      pwaDesc:'Browse back issues offline',
      pwaInstall:'Install',
      pwaIos:'Tap Share then "Add to Home Screen"',
      play:'Play in TokiQR'
    }
  };

  var lang=(navigator.language||'ja').startsWith('en')?'en':'ja';
  var configData=null;

  var listEl=document.getElementById('list');
  var res=await fetch('schedule.json');
  if(!res.ok){listEl.innerHTML='<p class="empty">'+L[lang].noSchedule+'</p>';return}
  var s=await res.json();
  var published=s.issues.filter(function(i){return i.status==='published'});

  var startYear=s.volume_start_year||2026;
  var volYears=s.volume_duration_years||20;

  try{
    var cr=await fetch('client-config.json?t='+Date.now());
    if(cr.ok){
      configData=await cr.json();
      if(configData.branding.accentColor){
        var rgb=configData.branding.accentColor;
        document.documentElement.style.setProperty('--accent','rgb('+rgb[0]+','+rgb[1]+','+rgb[2]+')');
        var tc=document.querySelector('meta[name="theme-color"]');
        if(tc)tc.setAttribute('content','rgb('+rgb[0]+','+rgb[1]+','+rgb[2]+')');
      }
    }
  }catch(e){}

  function getVolume(y){return Math.floor((y-startYear)/volYears)+1}
  function volPeriod(v){var sy=startYear+(v-1)*volYears;return sy+'–'+(sy+volYears-1)}
  function getCentury(y){return Math.floor(y/100)+1}
  function centuryRange(c){return((c-1)*100)+'–'+(c*100-1)}
  function issueYear(i){return parseInt(i.date.split('-')[0],10)}
  function formatDate(d){if(d.length>10){return d.slice(0,10)+' '+d.slice(11,19)}return d}
  function issuePath(i){return'output/'+(i.filename||('TQ-'+String(i.serial).padStart(5,'0')+'.pdf'))}
  function issueFullUrl(i){return window.location.href.replace(/[^/]*$/,'')+issuePath(i)}
  function tokiqrPlayUrl(i){return'https://tokistorage.github.io/qr/archive.html?pdf='+encodeURIComponent(issueFullUrl(i))}

  function render(){
    var t=L[lang];
    document.documentElement.lang=lang;

    if(configData){
      var name=lang==='en'
        ?(configData.branding.publicationNameEn||configData.branding.publicationNameJa||'Newsletter Archive')
        :(configData.branding.publicationNameJa||'Newsletter Archive');
      document.getElementById('title').textContent=name;
    }
    document.getElementById('sub').innerHTML=t.sub;
    document.getElementById('footer').innerHTML='<p style="margin-bottom:8px;font-size:.7rem;color:#b0b8c4;font-style:italic">'+t.mission+'</p>'+t.footer;
    document.getElementById('lang-btn').textContent=t.toggle;

    if(!published.length){listEl.innerHTML='<p class="empty">'+t.empty+'</p>';return}

    var volMap={};
    published.forEach(function(i){
      var v=getVolume(issueYear(i));
      if(!volMap[v])volMap[v]=[];
      volMap[v].push(i);
    });

    var vols=Object.keys(volMap).map(Number).sort();
    var centuryMap={};
    vols.forEach(function(v){
      var sy=startYear+(v-1)*volYears;
      var c=getCentury(sy);
      if(!centuryMap[c])centuryMap[c]=[];
      centuryMap[c].push(v);
    });

    var centuries=Object.keys(centuryMap).map(Number).sort();
    var latestCentury=centuries[centuries.length-1];
    var latestVol=vols[vols.length-1];

    var LATEST_MAX=10;
    var latest=published.slice().sort(function(a,b){return b.date.localeCompare(a.date)}).slice(0,LATEST_MAX);

    var html='<p class="section-label">'+t.latest+'</p>';
    latest.forEach(function(i){
      html+='<div class="issue-row">'
        +'<a class="issue" href="'+issuePath(i)+'">'
        +'<span class="issue-serial">TQ-'+String(i.serial).padStart(5,'0')+'</span>'
        +'<span class="issue-meta">'+formatDate(i.date)+(i.title?' — '+i.title:'')+'</span>'
        +'</a>'
        +'<a class="play-btn" href="'+tokiqrPlayUrl(i)+'" target="_blank" title="'+t.play+'">\u25B6</a>'
        +'</div>';
    });

    html+='<p class="section-label">'+t.backissues+'</p>';
    centuries.forEach(function(c){
      var volsInC=centuryMap[c];
      var countInC=0;
      volsInC.forEach(function(v){countInC+=volMap[v].length});
      var isLatestC=c===latestCentury;

      html+='<details class="century">'
        +'<summary>'+t.century(c,centuryRange(c))
        +'<span class="century-count">'+t.count(countInC)+'</span></summary>'
        +'<div class="century-inner">';

      volsInC.forEach(function(v){
        var issues=volMap[v];
        var isLatestV=v===latestVol;

        html+='<details class="vol">'
          +'<summary>'+t.vol(v,volPeriod(v))
          +'<span class="vol-count">'+t.count(issues.length)+'</span></summary>'
          +'<div class="vol-issues">';
        issues.forEach(function(i){
          html+='<div class="issue-row">'
            +'<a class="issue" href="'+issuePath(i)+'">'
            +'<span class="issue-serial">TQ-'+String(i.serial).padStart(5,'0')+'</span>'
            +'<span class="issue-meta">'+formatDate(i.date)+(i.title?' — '+i.title:'')+'</span>'
            +'</a>'
            +'<a class="play-btn" href="'+tokiqrPlayUrl(i)+'" target="_blank" title="'+t.play+'">\u25B6</a>'
            +'</div>';
        });
        html+='</div></details>';
      });

      html+='</div></details>';
    });

    listEl.innerHTML=html;
  }

  document.getElementById('lang-btn').addEventListener('click',function(){
    lang=lang==='ja'?'en':'ja';
    render();
  });

  render();
})();
</script>
<script>
(function(){
  if('serviceWorker' in navigator)navigator.serviceWorker.register('service-worker.js');

  var banner=document.getElementById('pwaBanner');
  var titleEl=document.getElementById('pwaTitle');
  var descEl=document.getElementById('pwaDesc');
  var btn=document.getElementById('pwaBtn');
  var closeBtn=document.getElementById('pwaClose');
  var deferredPrompt=null;

  function pwaLang(){
    return document.documentElement.lang==='en'?'en':'ja';
  }
  function isStandalone(){
    return window.matchMedia('(display-mode: standalone)').matches||navigator.standalone===true;
  }
  function isIos(){
    return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
  }
  function dismissed(){
    try{var d=localStorage.getItem('toki-nl-pwa-dismiss');if(!d)return false;return Date.now()-parseInt(d,10)<7*24*60*60*1000;}catch(e){return false;}
  }

  function showBanner(mode){
    if(isStandalone()||dismissed())return;
    var L={
      ja:{t:'ホーム画面に追加',d:'オフラインでもバックナンバーを閲覧できます',b:'追加',ios:'共有ボタン（□↑）→「ホーム画面に追加」をタップ'},
      en:{t:'Add to Home Screen',d:'Browse back issues offline',b:'Install',ios:'Tap Share then "Add to Home Screen"'}
    };
    var t=L[pwaLang()]||L.ja;
    titleEl.textContent=t.t;
    if(mode==='ios'){
      descEl.textContent=t.ios;
      btn.style.display='none';
    }else{
      descEl.textContent=t.d;
      btn.textContent=t.b;
      btn.style.display='';
    }
    banner.style.display='flex';
  }

  closeBtn.addEventListener('click',function(){
    banner.style.display='none';
    try{localStorage.setItem('toki-nl-pwa-dismiss',String(Date.now()));}catch(e){}
  });

  btn.addEventListener('click',function(){
    if(!deferredPrompt)return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function(){
      deferredPrompt=null;
      banner.style.display='none';
    });
  });

  window.addEventListener('beforeinstallprompt',function(e){
    e.preventDefault();
    deferredPrompt=e;
    showBanner('prompt');
  });

  if(isIos()&&!isStandalone()){
    setTimeout(function(){showBanner('ios');},2000);
  }
})();
</script>
</body>
</html>
