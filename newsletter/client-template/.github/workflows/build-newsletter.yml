name: Build Newsletter

on:
  push:
    branches: [main]
    paths: ['materials/*.json']
  workflow_run:
    workflows: ["Auto Merge"]
    types: [completed]

concurrency:
  group: build-newsletter
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: tokistorage/lp
          path: _lp
          sparse-checkout: newsletter/build-tokiqr-newsletter.py
          sparse-checkout-cone-mode: false

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y fonts-ipafont-gothic
          pip install fpdf2 "qrcode[pil]"

      - name: Build missing newsletters
        run: |
          for material in materials/*.json; do
            SERIAL=$(jq -r '.serial' "$material")
            SERIAL_STR=$(printf "%05d" "$SERIAL")
            if [ ! -f "output/TQ-${SERIAL_STR}.pdf" ]; then
              python3 _lp/newsletter/build-tokiqr-newsletter.py \
                "$material" client-config.json output/
            fi
          done

      - name: Create PR if changes exist
        run: |
          python3 -c "
          import json, glob, os
          schedule = json.load(open('schedule.json'))
          for p in sorted(glob.glob('materials/*.json')):
              m = json.load(open(p))
              s = m['serial']
              pdf = f'output/TQ-{s:05d}.pdf'
              if os.path.exists(pdf):
                  for i in schedule.get('issues', []):
                      if i['serial'] == s and i.get('status') == 'building':
                          i['status'] = 'published'
          json.dump(schedule, open('schedule.json', 'w'), indent=2, ensure_ascii=False)
          "
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/ schedule.json
          if ! git diff --cached --quiet; then
            BRANCH="build-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
            git commit -m "Build newsletter PDF(s)"
            git push origin "$BRANCH"
            gh pr create --title "Publish newsletter PDF(s)" --body "Automated build."
          fi
        env:
          GH_TOKEN: ${{ github.token }}
