<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="asset/favicon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="asset/apple-touch-icon.png">
    <title>CloudflareとGAS——使うことと、頼ることは違う | トキストレージ</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="トキストレージはCloudflare WorkersとGoogle Apps Scriptを運用に使っている。しかし永続するデータは、それらに一切依存しない。使うことと、頼ることは違う。">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;700&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --toki-blue: #1E40AF;
            --toki-blue-dark: #1E3A5F;
            --toki-blue-pale: #EFF6FF;
            --accent-blue: #3B82F6;
            --bg-white: #FFFFFF;
            --bg-section: #DBEAFE;
            --text-primary: #1E293B;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --border: #E2E8F0;
            --font-display: 'Shippori Mincho', serif;
            --font-body: 'Zen Kaku Gothic New', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            font-weight: 400;
            background: var(--bg-white);
            color: var(--text-primary);
            line-height: 1.9;
            font-size: 16px;
        }

        .article-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0.6rem 1.2rem;
            display: flex; align-items: center; justify-content: space-between; gap: 1rem;
        }
        .article-nav .nav-brand {
            font-family: var(--font-display); font-size: 0.9rem; font-weight: 600;
            color: var(--toki-blue); text-decoration: none; white-space: nowrap; flex-shrink: 0;
        }
        .article-nav .nav-right { display: flex; align-items: center; gap: 1rem; }
        .article-nav .nav-label { font-size: 0.6rem; color: var(--text-muted); letter-spacing: 0.08em; text-align: right; line-height: 1.4; }
        .article-nav .lang-switch { font-size: 0.75rem; color: var(--toki-blue); text-decoration: none; padding: 0.3rem 0.6rem; border: 1px solid var(--toki-blue); border-radius: 4px; }
        .article-nav .lang-switch:hover { background: var(--toki-blue); color: #fff; }

        .article-container { max-width: 720px; margin: 0 auto; padding: 5rem 2rem 4rem; }
        .article-header { margin-bottom: 3rem; }
        .article-category { font-size: 0.7rem; letter-spacing: 0.15em; color: var(--toki-blue); margin-bottom: 0.5rem; }
        .article-header h1 { font-family: var(--font-display); font-size: 1.8rem; font-weight: 700; line-height: 1.5; color: var(--text-primary); margin-bottom: 1rem; }
        .article-subtitle { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.8; }

        .article-content h2 { font-family: var(--font-display); font-size: 1.3rem; font-weight: 600; color: var(--toki-blue-dark); margin: 3rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .article-content h3 { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 2rem 0 0.8rem; }
        .article-content p { margin-bottom: 1.2rem; text-align: justify; }
        .article-content ul, .article-content ol { margin: 0.5rem 0 1.5rem 1.5rem; }
        .article-content li { margin-bottom: 0.5rem; }
        .article-content blockquote { border-left: 3px solid var(--toki-blue); padding: 1rem 1.5rem; margin: 1.5rem 0; background: var(--toki-blue-pale); font-style: italic; color: var(--text-secondary); }
        .article-content strong { color: var(--toki-blue-dark); }
        .article-content code { font-size: 0.88em; background: var(--toki-blue-pale); padding: 0.15em 0.4em; border-radius: 3px; }

        .core-message { background: var(--toki-blue-pale); border-left: 4px solid var(--toki-blue); padding: 1.2rem 1.5rem; margin: 0 0 2rem; font-size: 0.95rem; line-height: 1.8; }

        .phase-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.9rem; }
        .phase-table th, .phase-table td { padding: 0.7rem 1rem; border: 1px solid var(--border); text-align: left; }
        .phase-table th { background: var(--toki-blue-pale); font-weight: 600; color: var(--toki-blue-dark); font-size: 0.85rem; }
        .phase-table td { vertical-align: top; }

        .highlight-box { background: linear-gradient(135deg, var(--toki-blue-pale), #fff); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin: 2rem 0; text-align: center; }
        .highlight-box p { text-align: center; margin-bottom: 0.5rem; }
        .highlight-box .big { font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; color: var(--toki-blue-dark); }

        .article-footer { margin-top: 4rem; padding: 2rem 0; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted); line-height: 2.2; }
        .article-footer a { color: var(--text-muted); text-decoration: none; }
        .article-footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .article-container { padding: 6rem 1.2rem 3rem; }
            .article-header h1 { font-size: 1.5rem; }
            .article-nav .nav-label { display: none; }
            .phase-table { font-size: 0.8rem; }
            .phase-table th, .phase-table td { padding: 0.5rem 0.6rem; }
        }
        @media print { .article-nav { display: none; } .article-container { padding-top: 2rem; } }
        .nav-brand::before { content: ''; display: inline-block; width: 20px; height: 20px; background: url('asset/tokistorage-icon-512.png') no-repeat center / contain; vertical-align: -3px; margin-right: 5px; }
    </style>
<link rel="stylesheet" href="contact-form.css">
    <meta property="og:image" content="https://tokistorage.github.io/lp/asset/tokistorage-icon-512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
</head>
<body>

<nav class="article-nav">
    <a href="index.html" class="nav-brand">トキストレージ</a>
    <div class="nav-right">
        <span class="nav-label">技術・設計 / CloudflareとGAS</span>
        <a href="cloudflare-gas-en.html" class="lang-switch">EN</a>
    </div>
</nav>

<main class="article-container">

    <header class="article-header">
        <p class="article-category">ESSAY — 技術・設計</p>
        <h1>CloudflareとGAS——使うことと、頼ることは違う</h1>
        <p class="article-subtitle">
            トキストレージはCloudflare WorkersとGoogle Apps Scriptを使っている。<br>
            しかし永続するデータは、それらに一切依存しない。
        </p>
    </header>

    <article class="article-content">

        <div class="core-message">
            <strong>この記事で言いたいこと：</strong>トキストレージはCloudflare WorkersとGoogle Apps Script（GAS）を運用に使っている。注文処理、問い合わせ受付、アクセス解析。便利だから使う。しかし、1000年残すべきデータ——QRコードに刻まれた音声、物理製品、国立国会図書館への納本——は、CloudflareにもGASにも一切依存しない。使うことと頼ることは違う。その境界線を設計で引いている。
        </div>


        <h2>1. まず認める——使っている</h2>

        <p>トキストレージのコードベースには、Cloudflare WorkersとGASが組み込まれている。隠す必要はない。事実として整理する。</p>

        <h3>Cloudflare Workers</h3>
        <p>注文フォームと問い合わせフォーム（QRサイト側）は、Cloudflare Workerを経由してGASに送信される。GASのexec URLは302リダイレクトを返すため、WiseのWebhook URLバリデーションに通らない。Cloudflare Workerはその中継役だ。CORSの処理も担う。</p>

        <h3>Google Apps Script</h3>
        <p>GASは3つの役割を担っている。</p>
        <ul>
            <li><strong>注文・問い合わせの受信</strong>——フォームデータをGoogleスプレッドシートに記録し、メールで通知する</li>
            <li><strong>アクセス解析</strong>——ページビューをCookie UUIDで識別し、スプレッドシートにログを記録する</li>
            <li><strong>Wise Webhook</strong>——決済通知をCloudflare Worker経由で受け取る</li>
        </ul>

        <p>つまり、<strong>運用のバックエンドはCloudflare Workers + GAS + Googleスプレッドシート</strong>で構成されている。これはまぎれもない外部依存だ。</p>

        <blockquote>
            「使っていない」と言うのは簡単だ。<br>
            「使っているが、何に依存させていないか」を言語化する方が誠実だ。
        </blockquote>


        <h2>2. 運用レイヤーと永続レイヤー</h2>

        <p>トキストレージのアーキテクチャには、2つのレイヤーがある。</p>

        <table class="phase-table">
            <tr>
                <th></th>
                <th>運用レイヤー</th>
                <th>永続レイヤー</th>
            </tr>
            <tr>
                <td><strong>役割</strong></td>
                <td>注文受付、問い合わせ、解析</td>
                <td>音声の保存、存在の記録</td>
            </tr>
            <tr>
                <td><strong>依存先</strong></td>
                <td>Cloudflare Workers, GAS, Google Sheets</td>
                <td>QRコード（物理）, GitHub, NDL</td>
            </tr>
            <tr>
                <td><strong>寿命の想定</strong></td>
                <td>数年〜十数年</td>
                <td>100年〜1000年</td>
            </tr>
            <tr>
                <td><strong>代替可能性</strong></td>
                <td>他のサービスで代替可能</td>
                <td>代替不可——データ自体が自己完結</td>
            </tr>
            <tr>
                <td><strong>停止時の影響</strong></td>
                <td>新規注文が受けられない</td>
                <td>影響なし——既存のQRコードは永久に再生可能</td>
            </tr>
        </table>

        <p>この分離が設計の核心だ。<strong>運用レイヤーは外部に依存してよい。しかし永続レイヤーは、何にも依存してはならない。</strong></p>

        <p>QRコードに刻まれた音声データは、URLパラメータとしてQRコード内に完結している。サーバーに問い合わせる必要がない。CloudflareもGASもGoogleスプレッドシートも関係ない。QRコードを読み取り、ブラウザで開くだけで音声が再生される。</p>


        <h2>3. もしCloudflareが消えたら</h2>

        <p>Cloudflare Workerが停止した場合、影響を受けるのは以下だ。</p>

        <ul>
            <li>QRサイトの注文フォームが送信できなくなる</li>
            <li>QRサイトの問い合わせフォームが送信できなくなる</li>
            <li>WiseのWebhook通知が届かなくなる</li>
        </ul>

        <p>影響を受けないものは以下だ。</p>

        <ul>
            <li><strong>すべての既存QRコード</strong>——再生に一切影響なし</li>
            <li><strong>QR生成ツール</strong>——完全にクライアントサイドで動作</li>
            <li><strong>すべての物理製品</strong>——QRコードが刻まれた金属プレートは物理的に存在し続ける</li>
            <li><strong>NDLの記録</strong>——国立国会図書館に納本されたニュースレターは独立して保存されている</li>
        </ul>

        <p>復旧は容易だ。GASのexec URLに直接POSTするようフォームを書き換えるか、別のプロキシサービスに差し替えればよい。Cloudflare Workerのコードはわずか52行だ。</p>


        <h2>4. もしGASが消えたら</h2>

        <p>GASがEOL（End of Life）になった場合、影響を受けるのは以下だ。</p>

        <ul>
            <li>注文・問い合わせのスプレッドシート記録が停止する</li>
            <li>メール通知が届かなくなる</li>
            <li>アクセス解析が停止する</li>
        </ul>

        <p>影響を受けないものは以下だ。</p>

        <ul>
            <li><strong>すべての既存QRコード</strong>——再生に一切影響なし</li>
            <li><strong>すべての物理製品</strong>——変わらず存在し続ける</li>
            <li><strong>NDLの記録</strong>——独立して永続する</li>
            <li><strong>LPサイト</strong>——静的HTMLなので、GASが消えてもフォームとトラッカー以外は正常に表示される</li>
        </ul>

        <p>代替策もある。GASのコードは131行のシンプルなスクリプトだ。フォーム受信・スプレッドシート記録・メール通知。同等の機能は、Supabase、Netlify Functions、あるいは単純なメールAPIで代替できる。</p>


        <h2>5. 依存の設計原則</h2>

        <p>トキストレージの外部依存には、明確な原則がある。</p>

        <h3>原則1: 永続レイヤーは外部に依存させない</h3>
        <p>QRコードのデータはURLパラメータとして自己完結する。音声の復号はクライアントサイドのWASMで行う。物理製品は金属に刻印される。NDLへの納本は紙と電子の両方で行われる。いずれも、Cloudflare/GAS/GitHub/BASEの生死に影響されない。</p>

        <h3>原則2: 運用レイヤーは便利なものを使い、代替可能に保つ</h3>
        <p>GASを使う理由は単純だ。無料で、セットアップが速く、スプレッドシートとの連携が自然だからだ。Cloudflare Workerを使う理由は、GASの302リダイレクト問題を解決するためだ。どちらも合理的な選択だが、<strong>どちらも明日差し替え可能なように設計している</strong>。</p>

        <h3>原則3: 依存先のコードを自分で保持する</h3>
        <p>GASのソースコード（<code>contact-form-gas.js</code>）はリポジトリに保管されている。Cloudflare Workerのソースコード（<code>wise-webhook-proxy.js</code>）もリポジトリにある。サービスが消えても、ロジックは手元に残る。</p>

        <h3>原則4: パイプラインに秘匿データを流さない</h3>
        <p>そもそも、Cloudflare WorkerとGASを通過するデータに「漏れたら困るもの」がない。これが最も根本的な設計原則だ。</p>

        <blockquote>
            外部サービスを使うなら、そのサービスが消えた日のことを設計に含めろ。<br>
            そして、そのパイプラインに秘匿データを流すな。
        </blockquote>


        <h2>6. 漏れて困るデータがない</h2>

        <p>注文フォームからCloudflare Worker → GAS → Googleスプレッドシートに流れるデータを整理する。</p>

        <table class="phase-table">
            <tr>
                <th>データ</th>
                <th>パイプライン経由</th>
                <th>最終的な行き先</th>
            </tr>
            <tr>
                <td><strong>QR URL（音声データ）</strong></td>
                <td>注文情報として送信</td>
                <td>物理製品に刻印、GitHub公開（選択時）、NDL納本（選択時）</td>
            </tr>
            <tr>
                <td><strong>名前・住所</strong></td>
                <td>配送先として送信</td>
                <td>配送ラベル。<code>includePersonal</code>選択時はアーカイブにも含まれる</td>
            </tr>
            <tr>
                <td><strong>保管オプション</strong></td>
                <td>選択内容として送信</td>
                <td>どの公開保管レイヤーに乗せるかの指示</td>
            </tr>
            <tr>
                <td><strong>クレジットカード情報</strong></td>
                <td>一切通過しない</td>
                <td>Wiseのプラットフォーム上で直接入力・処理（PCI DSS準拠）</td>
            </tr>
        </table>

        <p>QR URLに含まれる音声データは、最終的に物理製品に刻まれ、希望すればGitHubで公開され、NDLに納本される。<strong>公開を前提としたデータ</strong>だ。名前と住所は配送に必要な情報であり、購入者が望めばアーカイブにも含まれる。</p>

        <p>そしてクレジットカード情報は、このパイプラインを一切通らない。決済はWiseのプラットフォーム上で完結する。注文確定後にWiseの決済リンクがメールで届き、購入者はWise上でカード情報を入力する。トキストレージのCloudflare WorkerにもGASにもGoogleスプレッドシートにも、カード番号は一度も記録されない。</p>

        <p><strong>パイプラインに秘密が存在しない</strong>——これは偶然ではなく、設計だ。保管対象のデータが公開前提であること、決済を外部プラットフォームに委託していること、この二つの設計判断が、外部サービスを安全に使える構造を作っている。</p>

        <p>この設計思想の原点は、技術書ではなく墓地にある。家紋、苗字、墓誌——お寺でも公営墓地でも、墓石は見る人を選ばない。拒まない。永く残すものは、最初から公開を前提に刻まれる。トキストレージのQRコードも、同じ構造をとっている。</p>

        <blockquote>
            セキュリティの最善策は、守るべき秘密をそもそも持たないことだ。<br>
            墓石はそれを、何百年も前から知っている。
        </blockquote>


        <h2>7. 結び——使うことと、頼ることは違う</h2>

        <div class="highlight-box">
            <p class="big">使うことと、頼ることは違う。</p>
            <p>壊れたら困るものを外部に置くな。<br>壊れても困らないものは、便利なところに置け。</p>
        </div>

        <p>トキストレージはCloudflare WorkersとGASを使っている。これは事実だ。</p>

        <p>しかし、これまで製造したすべてのQRコード、すべての物理製品、NDLに納本されたすべてのニュースレターは、CloudflareにもGASにも一切依存していない。明日両方のサービスが消えても、<strong>永続すべきものは何ひとつ失われない</strong>。</p>

        <p>これは偶然ではない。最初からそう設計した。</p>

        <p>外部サービスは道具だ。良い道具は使えばいい。しかし道具に命綱を預けてはならない。命綱は、自分の手の中になければならない。</p>

        <h2>関連エッセイ</h2>
        <ul>
            <li><a href="uptime.html">稼働率と外部依存 — 99.9%の先にあるもの</a></li>
            <li><a href="ssdlc.html">SSDLC — セキュリティが倫理になるとき</a></li>
            <li><a href="enterprise-architecture.html">エンタープライズアーキテクチャ — 初期設計という不可逆の選択</a></li>
            <li><a href="what-is-github.html">GitHubとは何か</a></li>
        </ul>

    </article>

    <footer class="article-footer">
        <p id="essay-nav-links"></p>
        <p style="margin-top: 2rem; font-size: 0.75rem;">&copy; 2026 TokiStorage</p>
    </footer>

</main>

<script src="contact-form.js"></script>
<script src="essay-nav.js?v=20260218"></script>
<script src="tracker.js"></script>
</body>
</html>
