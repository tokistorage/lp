name: Deploy Notification

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types: [completed]

permissions:
  contents: write

jobs:
  notify:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Pages CDN propagation
        run: sleep 30

      - name: Verify site is live
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tokistorage.github.io/lp/)
          echo "HTTP status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "Warning: site returned $STATUS"
          fi

      - name: Comment on commit
        run: |
          gh api repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/comments \
            -f body="$(cat <<'EOF'
          ✅ **GitHub Pages デプロイ完了**
          https://tokistorage.github.io/lp/ で動作確認できます。
          EOF
          )"
        env:
          GH_TOKEN: ${{ github.token }}
